<#include "/WEB-INF/views/common/common.html"/>
<@layout>
<link rel="stylesheet" href="${ctx!}/res/pure/buttons-min.css">
<link rel="stylesheet" href="${ctx!}/res/layer/theme/default/layer.css">
<link rel="stylesheet" href="${ctx!}/res/css/main-page.css">
<link rel="stylesheet" href="//at.alicdn.com/t/font_725654_cawe1abi8nf.css">
<script>
    /*main 页面不可被 iframe 嵌套，如果被嵌套跳转到到登录页面*/
    if(top.location!=self.location){
        top.location = "${ctx!}/login";
    }
    /*浏览器全屏*/
    function fullScreen() {
        var el = document.documentElement,
            rfs = el.requestFullScreen || el.webkitRequestFullScreen || el.mozRequestFullScreen || el.msRequestFullScreen,
            wscript;
        if (typeof rfs != "undefined" && rfs) {
            rfs.call(el);
            return;
        }
        if (typeof window.ActiveXObject != "undefined") {
            wscript = new ActiveXObject("WScript.Shell");
            if (wscript) {
                wscript.SendKeys("{F11}");
            }
        }
    }
    /*浏览器退出全屏*/
    function exitFullScreen() {
        var el = document,
            cfs = el.cancelFullScreen || el.webkitCancelFullScreen || el.mozCancelFullScreen || el.exitFullScreen,
            wscript;
        if (typeof cfs != "undefined" && cfs) {
            cfs.call(el);
            return;
        }

        if (typeof window.ActiveXObject != "undefined") {
            wscript = new ActiveXObject("WScript.Shell");
            if (wscript != null) {
                wscript.SendKeys("{F11}");
            }
        }
    }
    function fullScreenToggleNew(obj) {
        if ($(obj).hasClass('full')) {
            exitFullScreen();
            $(obj).removeClass('full').attr('title', '点击全屏');
        } else {
            fullScreen();
            $(obj).addClass('full').attr('title', '点击退出全屏');
        }
    }
</script>
</head>
<body>
<div id="mainLayout" class="easyui-layout" fit="true" border="false">
    <div class="head" data-options="region:'north'" border="false">
        <span class="head-text" onclick="fullScreenToggleNew(this)" title="点击全屏" >物业管理</span>
        <span class="head-menu">
            你好, (${(session.auth_user_roles)!} )
            <a id="opeMenu" class="pure-button pure-button-primary " >
                ${(session.auth_user.name)!}
            </a>
            <div id="opeMenuItem" style="width:100px;">
                <div name="editInfo">修改个人信息</div>
                <div name="changePwd">修改密码</div>
                <div name="logout">退出</div>
            </div>
            <script>
                ;(function(){
                    function openEditInfoForm() {
                        popup.openIframe('修改用户信息', '${ctx!}/userInfo', '560px', '600px');
                    }
                    function openChangePwdForm(){
                        popup.openIframe('修改密码', '${ctx!}/userPassword', '560px', '400px');
                    }
                    function logout(){
                        var logoutUrl = '${ctx!}/logout';
                        window.location.href=logoutUrl;
                    }

                    var opeMenu = $('#opeMenu').menubutton({ menu: '#opeMenuItem' });
                    $(opeMenu.menubutton('options').menu).menu({
                        onClick: function (item) {
                            switch (item.name){
                                case 'editInfo':  openEditInfoForm() ;break;
                                case 'changePwd': openChangePwdForm() ;break;
                                case 'logout': logout() ;break;
                            }
                        }
                    })
                })();
            </script>
        </span>
    </div>
    <div data-options="region:'west',split:false" title="&nbsp;&nbsp;功能导航" headerCls="borderTopNone grayBg" bodyCls="grayBg" style=" width:200px;">
        <div class="input-control">
            <input type="text" id="filterInput" placeholder="输入关键字、Enter过滤">
        </div>
        <ul id="permissionTree" style="margin-left:9px">
        </ul>
    </div>
    <div data-options="region:'center'" border="false" >
        <!-- pill="true" narrow="true" plain="true" tab 可选样式-->
        <div id="tabGroup"   pill="false"  narrow="false" plain="true" ></div>
        <div id="tabsMenu" class="easyui-menu">
            <div data-options="name:0">刷新</div>
            <div class="menu-sep"></div>
            <div data-options="name:1">关闭</div>
            <div data-options="name:2">关闭其它</div>
            <div data-options="name:3">关闭所有</div>
            <div class="menu-sep"></div>
            <div data-options="name:4">打开新页面</div>
        </div>
    </div>
</div>
<script src="${ctx!}/res/js/easyui-tree-tools.js"></script>
<script src="${ctx!}/res/js/tab-tools.js"></script>
<script src="${ctx!}/res/layer/layer.js"></script>
<script src="${ctx!}/res/js/popup-tools.js"></script>
<script>
    ;(function () {
        var MainPage = {
            init: function () {
                var that = this;
                that.permissTreeInit();
                TabTools.contextMenuInit();
                that.bind();
            },
            permissTreeInit: function () {
                /* 初始化左侧 菜单 并绑定事件*/
                var easyTree = new EasyTree();
                $.ajax({
                    url: "${ctx!}/main/permissionTree",
                    type: "GET",
                    dataType: "json",
                    success: function (data) {
                        var treeData = easyTree.treeDataBuild(data, "id", "pid", "text,iconCls,url");
                        $('#permissionTree').tree({
                            data: treeData,
                            onSelect: function (node) {
                                /* 只能打开 叶子node*/
                                if ($("#tree").tree("isLeaf", node.target)) {
                                    TabTools.addOrRefresh("${ctx!}"+node.url, "", node.text, node.iconCls);
                                }
                            }
                        });
                    },
                    error: function (x, m) {
                        console.log("权限数据请求错误: " + m);
                    }
                });
            },
            bind: function () {
                /* 权限树过滤（根据输入框内容过滤）*/
                $("#filterInput").on("keydown", function () {
                    if (event.keyCode == "13") {
                        var inputVal = $(this).val();
                        var aryTemp =[];
                        $('#permissionTree').tree({
                            filter: function (q, node) {
                                var flag =  node.text.indexOf(inputVal) >= 0;
                                if(flag){
                                    /* text 直接符合条件*/
                                    var nodex =  $('#permissionTree').tree('find',node.id);
                                    aryTemp =   $('#permissionTree').tree("getChildren",nodex.target);
                                    return true;
                                }else{
                                    /* 符合条件节点的子孙节点 */
                                  for(var i=0;i<aryTemp.length;i++){
                                      if(aryTemp[i].id == node.id){
                                          return true;
                                      }
                                  }
                                  return false;
                                }
                                /*return  node.text.indexOf(inputVal) >= 0 ;*/
                            }
                        });
                        if ($.trim(inputVal) == "" || inputVal == null || inputVal == undefined ) {
                            $('#tt').tree('doFilter', '');
                        } else {
                            $('#permissionTree').tree('doFilter', inputVal);
                        }
                    }
                })
            }
        };
        MainPage.init();
    })();
</script>
</@layout>